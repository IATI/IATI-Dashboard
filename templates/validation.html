{% extends 'base.html' %}
{% block title %}
{{ super () }} - Validation
{% endblock %}
{% block content %}
    <div class="page-header">
      <h1>Validation Against the Schema</h1>
      <p class="lead"></p>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Number of IATI files on the registry that don't validate</h3>
          </div>
          <div class="panel-body big-number">
            {{current_stats.aggregated.validation.fail}}
          </div>
          <div class="panel-body">
            <img src="validation.png" width="100%" />
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Number of publishers with files that don't validate</h3>
          </div>
          <div class="panel-body big-number">
            {{current_stats.aggregated.publishers_validation.fail}}
          </div>
          <div class="panel-body">
            <img src="publishers_validation.png" width="100%" />
          </div>
        </div>
      </div>
    </div>

    <h2>Breakdown By Publisher</h2>

    <div class="col-md-6">
    {% for publisher,datasets in current_stats.inverted_file_grouped.validation.fail.items() %}
    <div class="row">
        <div class="panel panel-default">
          <!-- Default panel contents -->
          <div class="panel-heading"><h3 class="panel-title" id="list_{{publisher}}">{{publisher}} ({{datasets|length}})</h3></div>
          <!--<div class="panel-body">
            <p>...</p>
          </div>-->

          <!-- List group -->
          <ul class="list-group">
            {% for dataset in datasets %}
            <li class="list-group-item">
              <div class="row">
                <div class="col-md-4 wrap">
                  <a href="http://iatiregistry.org/dataset/{{dataset}}">{{dataset}}</a>
                </div>
                <div class="col-md-6 wrap">
                  {% if publisher in ckan and dataset in ckan[publisher] %}
                  <a href="{{ckan[publisher][dataset].resource.url}}">{{ckan[publisher][dataset].resource.url|url_to_filename}}</a>
                  {% endif %}
                </div>
                <div class="col-md-2 wrap">
                   {% if publisher in ckan and dataset in ckan[publisher] %}
                   <a href="http://validator.iatistandard.org/?url={{ckan[publisher][dataset].resource.url|urlencode}}">validator</a>
                   {% endif %}
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
    </div>
    {% endfor%}
    </div>
    
    <div class="col-md-6">
      <div class="panel panel-default">
        <table class="table table-striped">
          <tbody>
            <thead><tr><th>Publisher</th><th>Failing files</th></tr></thead>
            {% for publisher,datasets in current_stats.inverted_file_grouped.validation.fail.items() %}
            <tr>
              <td><a href="#list_{{publisher}}">{{publisher}}</a></td>
              <td>{{datasets|length}}</td>
            </tr>
            {% endfor%}
          </tbody>
        </table>
      </div> 
    </div>
{% endblock %}
